var C=Object.defineProperty;var x=(h,e,t)=>e in h?C(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var m=(h,e,t)=>(x(h,typeof e!="symbol"?e+"":e,t),t);import{c as R,g as P,v as p,f as y,i as v,a as M,b as $}from"./index-b033b030.js";import"./vendor-1ddf23d8.js";import"./utils-fe999659.js";class w{constructor(e,t,n,s,a=[]){m(this,"classroom");m(this,"constraints");m(this,"availableSeats");m(this,"randomConfig");m(this,"placementHistory",[]);m(this,"diversityMap",new Map);m(this,"rng");m(this,"fixedPlacements");m(this,"fixedSeating");this.classroom=e,this.constraints=t,this.fixedPlacements=a,this.fixedSeating=R(a),this.availableSeats=P(e,a),this.randomConfig=this.createRandomConfig(n),this.rng=this.createSeededRandom(s),this.initializeDiversityMap()}async generatePlacement(e){console.log(`üé≤ Ï†ÅÏùëÌòï ÎûúÎç§ Ìú¥Î¶¨Ïä§Ìã± ÏãúÏûë (Î™®Îìú: ${this.randomConfig.mode})`);const t=new Set(this.fixedPlacements.map(d=>d.studentId)),n=e.filter(d=>!t.has(d.id)),s={...this.fixedSeating},a=new Set(t);let o=[...n];const r=[{name:"Ï†úÏïΩÏ°∞Í±¥ Ïö∞ÏÑ†",weight:.8,randomness:.2},{name:"Ìú¥Î¶¨Ïä§Ìã± Í∏∞Î∞ò",weight:.6,randomness:.4},{name:"Ï†ÅÏùëÌòï ÌÉêÏÉâ",weight:.4,randomness:.6},{name:"Îã§ÏñëÏÑ± Ï∂îÍµ¨",weight:.2,randomness:.8}];for(const d of r){if(o.length===0)break;console.log(`üìç ${d.name} Îã®Í≥Ñ ÏãúÏûë (ÎûúÎç§ÏÑ±: ${(d.randomness*100).toFixed(0)}%)`);const f={...this.randomConfig,studentSelectionRandomness:this.randomConfig.studentSelectionRandomness*d.randomness,seatSelectionRandomness:this.randomConfig.seatSelectionRandomness*d.randomness},S=await this.executePlacementPhase(o,s,f,d.name);Object.assign(s,S.newPlacements),S.placedStudentIds.forEach(g=>a.add(g)),o=o.filter(g=>!a.has(g.id)),console.log(`‚úÖ ${d.name} ÏôÑÎ£å: ${S.placedStudentIds.length}Î™Ö Î∞∞Ïπò`)}const i=p(s,e,this.classroom,this.constraints),c=this.createStats(s,e),l=this.calculateDiversityScore(s),u=this.generateResultMessage(c,l,this.randomConfig.mode,this.fixedPlacements.length);return{success:o.length===0,seating:s,message:u,violations:i.violations,stats:c}}async executePlacementPhase(e,t,n,s){const a={},o=[];let r=[...e];for(;r.length>0;){const i=this.selectNextStudent(r,t,n);if(!i)break;const c=this.evaluateSeatCandidates(i.student,t,a,n);if(c.length===0){r=r.filter(f=>f.id!==i.student.id);continue}const l=this.selectSeatWithRandomness(c,n),u={student:i.student,position:l.position,confidence:this.calculatePlacementConfidence(i,l),randomInfluence:this.calculateRandomInfluence(i,l,n),alternativeCount:c.length-1,reasoning:this.generatePlacementReasoning(i,l,n,s)},d=`${l.position.row}-${l.position.col}`;if(a[d]=i.student.id,o.push(i.student.id),r=r.filter(f=>f.id!==i.student.id),this.placementHistory.push(u),this.updateDiversityMap(l.position,i.student),n.mode==="exploratory"&&this.rng()<.1){console.log(`üéØ ÌÉêÌóòÏ†Å Ï°∞Í∏∞ Ï¢ÖÎ£å (${s})`);break}}return{newPlacements:a,placedStudentIds:o}}selectNextStudent(e,t,n){if(e.length===0)return null;const s=e.map(a=>{const o=this.calculateStudentHeuristicScore(a,t),r=this.rng()*n.studentSelectionRandomness,i=this.calculateStudentDiversityBonus(a,t)*n.diversityBoost/100,c=o+r+i;return{student:a,baseScore:o,randomBonus:r,finalScore:c,selectionReason:this.generateStudentSelectionReason(o,r,i)}});if(this.rng()<n.explorationProbability/100){const a=s.sort((r,i)=>i.finalScore-r.finalScore).slice(0,Math.max(1,Math.ceil(s.length*.3))),o=Math.floor(this.rng()*a.length);return a[o]}else{const o=s.sort((l,u)=>u.finalScore-l.finalScore).slice(0,3),r=[.6,.3,.1],i=this.rng();let c=0;for(let l=0;l<o.length;l++)if(c+=r[l],i<=c)return o[l];return o[0]}}evaluateSeatCandidates(e,t,n,s){const a={...t,...n};return this.availableSeats.filter(i=>{const c=`${i.row}-${i.col}`;return!a[c]}).map(i=>{const c=this.evaluateConstraintScore(e,i,a),l=this.evaluateHeuristicScore(e,i,a),u=this.rng()*s.seatSelectionRandomness,d=this.evaluateSeatDiversityScore(i,e)*s.diversityBoost/100,f=this.evaluateRiskLevel(c,l),S=this.calculateFinalSeatScore(c,l,u,d,s);return{position:i,constraintScore:c,heuristicScore:l,randomFactor:u,diversityScore:d,finalScore:S,riskLevel:f}}).filter(i=>i.constraintScore>=0&&(s.mode==="chaos"||i.riskLevel!=="risky"))}selectSeatWithRandomness(e,t){if(e.length===1)return e[0];switch(t.mode){case"conservative":return this.selectConservatively(e);case"balanced":return this.selectBalanced(e,t);case"exploratory":return this.selectExploratory(e,t);case"chaos":return this.selectChaotic(e);default:return e[0]}}selectConservatively(e){const t=e.filter(n=>n.riskLevel==="safe");return t.length>0?t.reduce((n,s)=>s.constraintScore>n.constraintScore?s:n):e.reduce((n,s)=>s.finalScore>n.finalScore?s:n)}selectBalanced(e,t){const s=e.sort((c,l)=>l.finalScore-c.finalScore).slice(0,Math.max(1,Math.ceil(e.length*.5))),a=s.map((c,l)=>Math.exp(-l*.5)),o=a.reduce((c,l)=>c+l,0),r=this.rng()*o;let i=0;for(let c=0;c<s.length;c++)if(i+=a[c],r<=i)return s[c];return s[0]}selectExploratory(e,t){const a=e.map(r=>({...r,exploratoryScore:r.finalScore+r.diversityScore*2})).sort((r,i)=>i.exploratoryScore-r.exploratoryScore).slice(0,Math.ceil(e.length*.7)),o=Math.floor(this.rng()*a.length);return a[o]}selectChaotic(e){const t=Math.floor(this.rng()*e.length);return e[t]}createRandomConfig(e){return{...{mode:"balanced",studentSelectionRandomness:30,seatSelectionRandomness:25,constraintFlexibility:10,diversityBoost:40,explorationProbability:20},...e}}createSeededRandom(e){let t=e||Date.now()%2147483647;return()=>(t=t*16807%2147483647,(t-1)/2147483646)}initializeDiversityMap(){this.availableSeats.forEach(e=>{const t=`${e.row}-${e.col}`;this.diversityMap.set(t,0)})}calculateStudentHeuristicScore(e,t){let n=50;const s=this.getStudentConstraintCount(e.id);n+=s*15;const a=this.calculateGenderBalance(t);return e.gender==="male"&&a.maleRatio<.4&&(n+=10),e.gender==="female"&&a.femaleRatio<.4&&(n+=10),Math.max(0,Math.min(100,n))}calculateStudentDiversityBonus(e,t){let n=0;return Object.values(t).map(o=>"unknown").filter(o=>o===e.gender).length<Object.keys(t).length*.4&&(n+=20),n}evaluateConstraintScore(e,t,n){var r,i;let s=100;const a=(r=this.classroom.seatGenderConstraints)==null?void 0:r.find(c=>c.position.row===t.row&&c.position.col===t.col);return a!=null&&a.requiredGender&&e.gender!==a.requiredGender||((i=this.classroom.seatUsageConstraints)==null?void 0:i.find(c=>c.position.row===t.row&&c.position.col===t.col&&c.isDisabled))?-100:(s-=this.evaluatePairConstraintViolations(e,t,n)*30,s-=this.evaluateDistanceConstraintViolations(e,t,n)*25,Math.max(-100,Math.min(100,s)))}evaluateHeuristicScore(e,t,n){let s=50;const a=(this.classroom.rows-1)/2,o=(this.classroom.cols-1)/2,r=Math.abs(t.row-a)+Math.abs(t.col-o);s+=Math.max(0,20-r*2),this.countNearbyGender(e.gender,t,n)>2&&(s-=15);const c=this.countNearbyEmptySeats(t,n);return s+=c*3,Math.max(0,Math.min(100,s))}evaluateSeatDiversityScore(e,t){const n=`${e.row}-${e.col}`,s=this.diversityMap.get(n)||0;return Math.max(0,100-s*10)}evaluateRiskLevel(e,t){const n=e+t;return e<0?"risky":n>120?"safe":n>80?"moderate":"risky"}calculateFinalSeatScore(e,t,n,s,a){let o=.5,r=.3,i=.1,c=.1;switch(a.mode){case"conservative":o=.7,r=.2,i=.05,c=.05;break;case"balanced":o=.4,r=.3,i=.15,c=.15;break;case"exploratory":o=.3,r=.2,i=.25,c=.25;break;case"chaos":o=.2,r=.1,i=.5,c=.2;break}return e*o+t*r+n*i+s*c}getStudentConstraintCount(e){return this.constraints.pairRequired.filter(t=>t.students.includes(e)).length+this.constraints.pairProhibited.filter(t=>t.students.includes(e)).length+this.constraints.distanceRules.filter(t=>t.students.includes(e)).length}calculateGenderBalance(e){return Object.keys(e).length===0?{maleRatio:.5,femaleRatio:.5}:{maleRatio:.5,femaleRatio:.5}}evaluatePairConstraintViolations(e,t,n){let s=0;return this.constraints.pairRequired.forEach(a=>{if(a.students.includes(e.id)){const o=a.students.find(r=>r!==e.id);if(o){const r=y(o,n);r&&!v(t,r)&&s++}}}),this.constraints.pairProhibited.forEach(a=>{if(a.students.includes(e.id)){const o=a.students.find(r=>r!==e.id);if(o){const r=y(o,n);r&&v(t,r)&&s++}}}),s}evaluateDistanceConstraintViolations(e,t,n){let s=0;return this.constraints.distanceRules.forEach(a=>{if(a.students.includes(e.id)){const o=a.students.find(r=>r!==e.id);if(o){const r=y(o,n);r&&M(t,r)<a.minDistance&&s++}}}),s}countNearbyGender(e,t,n){let s=0;return[{row:t.row-1,col:t.col-1},{row:t.row-1,col:t.col},{row:t.row-1,col:t.col+1},{row:t.row,col:t.col-1},{row:t.row,col:t.col+1},{row:t.row+1,col:t.col-1},{row:t.row+1,col:t.col},{row:t.row+1,col:t.col+1}].forEach(o=>{if(o.row>=0&&o.row<this.classroom.rows&&o.col>=0&&o.col<this.classroom.cols){const r=`${o.row}-${o.col}`;n[r]}}),s}countNearbyEmptySeats(e,t){let n=0;return[{row:e.row-1,col:e.col-1},{row:e.row-1,col:e.col},{row:e.row-1,col:e.col+1},{row:e.row,col:e.col-1},{row:e.row,col:e.col+1},{row:e.row+1,col:e.col-1},{row:e.row+1,col:e.col},{row:e.row+1,col:e.col+1}].forEach(a=>{if(a.row>=0&&a.row<this.classroom.rows&&a.col>=0&&a.col<this.classroom.cols){const o=`${a.row}-${a.col}`;t[o]||n++}}),n}calculatePlacementConfidence(e,t){const n=Math.max(0,Math.min(100,t.constraintScore)),s=Math.min(20,t.finalScore*.1);return Math.max(0,Math.min(100,n-s))}calculateRandomInfluence(e,t,n){const s=t.constraintScore+t.heuristicScore+t.randomFactor+t.diversityScore;return s<=0?0:t.randomFactor/s*100}generatePlacementReasoning(e,t,n,s){const a=[];return a.push(`${s} Îã®Í≥ÑÏóêÏÑú ÏÑ†ÌÉù`),t.constraintScore>50?a.push("Ï†úÏïΩÏ°∞Í±¥ ÎßåÏ°±"):t.constraintScore>0&&a.push("Ï†úÏïΩÏ°∞Í±¥ Î∂ÄÎ∂Ñ ÎßåÏ°±"),t.heuristicScore>60&&a.push("Ìú¥Î¶¨Ïä§Ìã± Ï†êÏàò Ïö∞Ïàò"),t.randomFactor>n.seatSelectionRandomness*.7&&a.push("ÎûúÎç§ÏÑ±ÏúºÎ°ú ÏÑ†ÌÉù"),t.diversityScore>70&&a.push("Îã§ÏñëÏÑ± Ï¶ùÏßÑ"),a.push(`ÏúÑÌóòÎèÑ: ${t.riskLevel}`),a}generateStudentSelectionReason(e,t,n){const s=[];return e>70&&s.push("ÎÜíÏùÄ Ïö∞ÏÑ†ÏàúÏúÑ"),t>20&&s.push("ÎûúÎç§ ÏÑ†ÌÉù"),n>15&&s.push("Îã§ÏñëÏÑ± Í∏∞Ïó¨"),s.join(", ")||"Í∏∞Î≥∏ ÏÑ†ÌÉù"}updateDiversityMap(e,t){const n=`${e.row}-${e.col}`,s=this.diversityMap.get(n)||0;this.diversityMap.set(n,s+1),[{row:e.row-1,col:e.col},{row:e.row+1,col:e.col},{row:e.row,col:e.col-1},{row:e.row,col:e.col+1}].forEach(o=>{if(o.row>=0&&o.row<this.classroom.rows&&o.col>=0&&o.col<this.classroom.cols){const r=`${o.row}-${o.col}`,i=this.diversityMap.get(r)||0;this.diversityMap.set(r,i+.5)}})}calculateDiversityScore(e){if(Object.keys(e).length===0)return 0;let t=0,n=0;return this.diversityMap.forEach((s,a)=>{e[a]&&(t+=s,n++)}),n>0?t/n:0}createStats(e,t){const n=this.classroom.rows*this.classroom.cols,s=Object.keys(e).length;return{totalSeats:n,availableSeats:this.availableSeats.length,disabledSeats:n-this.availableSeats.length,placedStudents:s,unplacedStudents:t.length-s,constraintViolations:0}}generateResultMessage(e,t,n,s){const a=e.placedStudents>0?(e.placedStudents/(e.placedStudents+e.unplacedStudents)*100).toFixed(1):"0";let i=`${{conservative:"ÏïàÏ†ïÏ†Å",balanced:"Í∑†ÌòïÏû°Ìûå",exploratory:"ÌÉêÌóòÏ†Å",chaos:"Ï∞ΩÏùòÏ†Å"}[n]||n} ÎûúÎç§ Ìú¥Î¶¨Ïä§Ìã± Î∞∞Ïπò: ${e.placedStudents}/${e.placedStudents+e.unplacedStudents}Î™Ö Î∞∞Ïπò (${a}%)`;s>0&&(i+=` (Í≥†Ï†ï ${s}Î™Ö Ìè¨Ìï®)`),t>0&&(i+=` | Îã§ÏñëÏÑ± Ï†êÏàò: ${t.toFixed(1)}`);const c=this.placementHistory.filter(l=>l.randomInfluence>30).length;return c>0&&(i+=` | ÎûúÎç§ Í≤∞Ï†ï: ${c}Í±¥`),i}getPlacementAnalysis(){const e=this.placementHistory.length;if(e===0)return{totalDecisions:0,averageConfidence:0,averageRandomInfluence:0,riskDistribution:{safe:0,moderate:0,risky:0},phaseBreakdown:{}};const t=this.placementHistory.reduce((o,r)=>o+r.confidence,0),n=this.placementHistory.reduce((o,r)=>o+r.randomInfluence,0),s={safe:0,moderate:0,risky:0},a={};return this.placementHistory.forEach(o=>{o.confidence>70?s.safe++:o.confidence>40?s.moderate++:s.risky++;const r=o.reasoning[0]||"unknown";a[r]=(a[r]||0)+1}),{totalDecisions:e,averageConfidence:t/e,averageRandomInfluence:n/e,riskDistribution:s,phaseBreakdown:a}}async generateAlternativePlacement(e,t){return this.rng=this.createSeededRandom(t||Date.now()),this.placementHistory=[],this.initializeDiversityMap(),await this.generatePlacement(e)}}const b={subtle:{mode:"conservative",studentSelectionRandomness:15,seatSelectionRandomness:10,constraintFlexibility:5,diversityBoost:20,explorationProbability:10},balanced:{mode:"balanced",studentSelectionRandomness:30,seatSelectionRandomness:25,constraintFlexibility:10,diversityBoost:40,explorationProbability:20},creative:{mode:"exploratory",studentSelectionRandomness:50,seatSelectionRandomness:45,constraintFlexibility:20,diversityBoost:60,explorationProbability:35},wild:{mode:"chaos",studentSelectionRandomness:80,seatSelectionRandomness:75,constraintFlexibility:40,diversityBoost:30,explorationProbability:60}},F=async(h,e,t={pairRequired:[],pairProhibited:[],distanceRules:[],rowExclusions:[]},n={})=>{const s=n.fixedPlacements||[];if(h.length===0)return{success:!1,seating:R(s),message:"Î∞∞ÏπòÌï† ÌïôÏÉùÏù¥ ÏóÜÏäµÎãàÎã§.",stats:{totalSeats:e.rows*e.cols,availableSeats:$(e).length,disabledSeats:0,placedStudents:s.length,unplacedStudents:0,constraintViolations:0}};let a;if(n.preset?a={...b[n.preset],...n.customConfig}:a={...b.balanced,...n.customConfig},n.generateMultiple&&n.generateMultiple>1){console.log(`üé≤ ${n.generateMultiple}Í∞úÏùò Î∞∞Ïπò ÌõÑÎ≥¥ ÏÉùÏÑ± Ï§ë...`);const i=[];for(let l=0;l<n.generateMultiple;l++){const d=await new w(e,t,a,n.seed?n.seed+l:void 0,s).generatePlacement(h);i.push({...d,message:`${d.message} (ÌõÑÎ≥¥ ${l+1}/${n.generateMultiple})`})}const c=i.reduce((l,u)=>{const d=l.stats.placedStudents*100-l.stats.constraintViolations*10;return u.stats.placedStudents*100-u.stats.constraintViolations*10>d?u:l});return c.message+=" | ÏµúÏ†Å ÏÑ†ÌÉùÎê®",c}return await new w(e,t,a,n.seed,s).generatePlacement(h)};export{w as AdaptiveRandomHeuristicEngine,b as RANDOMNESS_PRESETS,F as generateAdaptiveRandomPlacement};
